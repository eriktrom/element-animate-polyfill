import { toInt, forEach, findDimensionalSuffix } from '../util';
import { TRANSFORM_PROPERTIES } from '../transform_properties';
export class TransformStyleCalculator {
    setKeyframeRange(startValue, endValue) {
        var fromTransform = new _TransformDetails(startValue.toString());
        var toTransform = new _TransformDetails(endValue.toString());
        this._keyframes = generateKeyframesBetweenTransforms(fromTransform, toTransform);
        this._template = compileTemplateFromTransformProperties(toTransform.properties);
    }
    calculate(percentage) {
        for (var i = 0; i < this._keyframes.length; i++) {
            let entry = this._keyframes[i];
            let values = entry.calculateAtPercentage(percentage);
            var startIndex = this._template.getStartIndexForProperty(entry.property);
            for (var j = 0; j < values.length; j++) {
                this._template.set(startIndex + j + j, values[j]);
            }
        }
        return this._template.eval();
    }
}
class _StyleTemplate {
    constructor(tokens, _tokenLookup) {
        this.tokens = tokens;
        this._tokenLookup = _tokenLookup;
    }
    set(index, value) {
        this.tokens[index] = value;
    }
    getStartIndexForProperty(property) {
        return this._tokenLookup[property];
    }
    eval() {
        return this.tokens.join("");
    }
}
class _TransformInputValue {
    constructor(value, unit) {
        this.value = value;
        this.unit = unit;
    }
}
function splitTransformValue(value) {
    return value.split(/\s*,\s*/).map(rawValue => {
        return new _TransformInputValue(toInt(rawValue), findDimensionalSuffix(rawValue));
    });
}
class _TransformKeyframeValue {
    constructor(property, from, to) {
        this.property = property;
        this.s1 = 0;
        this.s2 = 0;
        this.s3 = 0;
        this.s4 = 0;
        this.d1 = 0;
        this.d2 = 0;
        this.d3 = 0;
        this.d4 = 0;
        var defaultEntry = TRANSFORM_PROPERTIES[property];
        var defaultValues = defaultEntry['defaults'];
        var defaultUnits = defaultEntry['units'];
        this.length = defaultValues.length;
        var fromValues = splitTransformValue(from);
        var toValues = splitTransformValue(to);
        var f1 = fromValues[0];
        var t1 = toValues[0];
        this.s1 = f1.value;
        this.d1 = t1.value - f1.value;
        this.units = [defaultUnits[0]];
        var l = fromValues.length;
        if (this.length > 1) {
            let unit = defaultUnits[1];
            if (l > 1) {
                let f2 = fromValues[1];
                let t2 = toValues[1];
                unit = f2.unit;
                this.s2 = f2.value;
                this.d2 = t2.value - f2.value;
            }
            else {
                this.s2 = defaultValues[1];
            }
            this.units.push(unit);
        }
        if (this.length > 2) {
            let unit = defaultUnits[2];
            if (l > 2) {
                let f3 = fromValues[2];
                let t3 = toValues[2];
                unit = f3.unit;
                this.s3 = f3.value;
                this.d3 = t3.value - f3.value;
            }
            else {
                this.s3 = defaultValues[2];
            }
            this.units.push(unit);
        }
        if (this.length > 3) {
            let unit = defaultUnits[3];
            if (l > 3) {
                let f4 = fromValues[3];
                let t4 = toValues[3];
                unit = f4.unit;
                this.s4 = f4.value;
                this.d4 = t4.value - f4.value;
            }
            else {
                this.s4 = defaultValues[3];
            }
            this.units.push(unit);
        }
    }
    calculateAtPercentage(percentage) {
        var units = this.units;
        var v1 = this.s1 + percentage * this.d1 + units[0];
        var v2 = this.s2 + percentage * this.d2 + units[1];
        var v3 = this.s3 + percentage * this.d3 + units[2];
        var v4 = this.s4 + percentage * this.d4 + units[3];
        var result = [v1, v2, v3, v4];
        result.length = this.length;
        return result;
    }
}
// we use look ahead here so that the split
// operation doesn't include the `\w+(` content
// as apart of the split delimeter.
var TRANSFORM_SPLIT_REGEX = new RegExp('\\s+' +
    '(?=\\w+\\()' // that are followed by a keyword containing a opening paren(
);
class _TransformDetails {
    constructor(style) {
        this.style = style;
        this.values = {};
        this.properties = [];
        style.split(TRANSFORM_SPLIT_REGEX).forEach(token => {
            var parenOpen = token.indexOf('(');
            var parenClose = token.lastIndexOf(')');
            var lhs = token.substring(0, parenOpen);
            var rhs = token.substring(parenOpen + 1, parenClose);
            this.values[lhs] = rhs;
            this.properties.push(lhs);
        });
    }
}
function compileTemplateFromTransformProperties(properties) {
    var tokens = [];
    var tokenLookup = {};
    properties.forEach(prop => {
        var entry = TRANSFORM_PROPERTIES[prop]['defaults'];
        tokens.push(prop);
        tokens.push("(");
        tokenLookup[prop] = tokens.length;
        for (var i = 0; i < entry.length; i++) {
            if (i > 0) {
                tokens.push(",");
            }
            tokens.push(true);
        }
        tokens.push(")");
        tokens.push(" ");
    });
    return new _StyleTemplate(tokens, tokenLookup);
}
function concatValuesAndUnits(values, units) {
    var combined = [];
    for (var i = 0; i < values.length; i++) {
        combined.push(values[i] + units[i]);
    }
    return combined.join(',');
}
function generateKeyframesBetweenTransforms(a, b) {
    var usedProperties = {};
    var from = {};
    var to = {};
    a.properties.forEach(prop => {
        usedProperties[prop] = 1;
        from[prop] = a.values[prop];
    });
    b.properties.forEach(prop => {
        var val = usedProperties[prop];
        usedProperties[prop] = val == 1 ? 0 : -1;
        to[prop] = b.values[prop];
    });
    var keyframes = [];
    forEach(usedProperties, (status, prop) => {
        let defaultValue = TRANSFORM_PROPERTIES[prop];
        if (status == 1) {
            to[prop] = concatValuesAndUnits(defaultValue.defaults, defaultValue.units);
        }
        else if (status == -1) {
            from[prop] = concatValuesAndUnits(defaultValue.defaults, defaultValue.units);
        }
        keyframes.push(new _TransformKeyframeValue(prop, from[prop], to[prop]));
    });
    return keyframes;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtX3N0eWxlX2NhbGN1bGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYWxjdWxhdG9ycy90cmFuc2Zvcm1fc3R5bGVfY2FsY3VsYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FDTyxFQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUscUJBQXFCLEVBQUMsTUFBTSxTQUFTO09BQ3RELEVBQUMsb0JBQW9CLEVBQWlDLE1BQU0seUJBQXlCO0FBRTVGO0lBSUUsZ0JBQWdCLENBQUMsVUFBeUIsRUFBRSxRQUF1QjtRQUNqRSxJQUFJLGFBQWEsR0FBRyxJQUFJLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLElBQUksV0FBVyxHQUFHLElBQUksaUJBQWlCLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxrQ0FBa0MsQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDakYsSUFBSSxDQUFDLFNBQVMsR0FBRyxzQ0FBc0MsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUVELFNBQVMsQ0FBQyxVQUFrQjtRQUMxQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDaEQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDckQsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDekUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdB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QUMsQ0FBQztJQUVILElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUNuQixPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUk7UUFDbkMsSUFBSSxZQUFZLEdBQUcsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEIsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdFLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsb0JBQW9CLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0UsQ0FBQztRQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUUsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1N0eWxlQ2FsY3VsYXRvcn0gZnJvbSAnLi4vc3R5bGVfY2FsY3VsYXRvcic7XG5pbXBvcnQge3RvSW50LCBmb3JFYWNoLCBmaW5kRGltZW5zaW9uYWxTdWZmaXh9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHtUUkFOU0ZPUk1fUFJPUEVSVElFUywgTk9fVU5JVCwgUFhfVU5JVCwgREVHUkVFU19VTklUfSBmcm9tICcuLi90cmFuc2Zvcm1fcHJvcGVydGllcyc7XG5cbmV4cG9ydCBjbGFzcyBUcmFuc2Zvcm1TdHlsZUNhbGN1bGF0b3IgaW1wbGVtZW50cyBTdHlsZUNhbGN1bGF0b3Ige1xuICBwcml2YXRlIF9rZXlmcmFtZXM6IF9UcmFuc2Zvcm1LZXlmcmFtZVZhbHVlW107XG4gIHByaXZhdGUgX3RlbXBsYXRlOiBfU3R5bGVUZW1wbGF0ZTtcblxuICBzZXRLZXlmcmFtZVJhbmdlKHN0YXJ0VmFsdWU6IG51bWJlcnxzdHJpbmcsIGVuZFZhbHVlOiBudW1iZXJ8c3RyaW5nKTogdm9pZCB7XG4gICAgdmFyIGZyb21UcmFuc2Zvcm0gPSBuZXcgX1RyYW5zZm9ybURldGFpbHMoc3RhcnRWYWx1ZS50b1N0cmluZygpKTtcbiAgICB2YXIgdG9UcmFuc2Zvcm0gPSBuZXcgX1RyYW5zZm9ybURldGFpbHMoZW5kVmFsdWUudG9TdHJpbmcoKSk7XG4gICAgdGhpcy5fa2V5ZnJhbWVzID0gZ2VuZXJhdGVLZXlmcmFtZXNCZXR3ZWVuVHJhbnNmb3Jtcyhmcm9tVHJhbnNmb3JtLCB0b1RyYW5zZm9ybSk7XG4gICAgdGhpcy5fdGVtcGxhdGUgPSBjb21waWxlVGVtcGxhdGVGcm9tVHJhbnNmb3JtUHJvcGVydGllcyh0b1RyYW5zZm9ybS5wcm9wZXJ0aWVzKTtcbiAgfVxuXG4gIGNhbGN1bGF0ZShwZXJjZW50YWdlOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fa2V5ZnJhbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZW50cnkgPSB0aGlzLl9rZXlmcmFtZXNbaV07XG4gICAgICBsZXQgdmFsdWVzID0gZW50cnkuY2FsY3VsYXRlQXRQZXJjZW50YWdlKHBlcmNlbnRhZ2UpO1xuICAgICAgdmFyIHN0YXJ0SW5kZXggPSB0aGlzLl90ZW1wbGF0ZS5nZXRTdGFydEluZGV4Rm9yUHJvcGVydHkoZW50cnkucHJvcGVydHkpO1xuICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWx1ZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgdGhpcy5fdGVtcGxhdGUuc2V0KHN0YXJ0SW5kZXggKyBqICsgaiwgdmFsdWVzW2pdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3RlbXBsYXRlLmV2YWwoKTtcbiAgfVxufVxuXG5jbGFzcyBfU3R5bGVUZW1wbGF0ZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdG9rZW5zOiBBcnJheTxzdHJpbmd8bnVtYmVyPiwgcHJpdmF0ZSBfdG9rZW5Mb29rdXA6IHtba2V5OiBzdHJpbmddOiBudW1iZXJ9KSB7fVxuXG4gIHNldChpbmRleDogbnVtYmVyLCB2YWx1ZTogc3RyaW5nfG51bWJlcikge1xuICAgIHRoaXMudG9rZW5zW2luZGV4XSA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0U3RhcnRJbmRleEZvclByb3BlcnR5KHByb3BlcnR5OiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl90b2tlbkxvb2t1cFtwcm9wZXJ0eV07IFxuICB9XG5cbiAgZXZhbCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRva2Vucy5qb2luKFwiXCIpO1xuICB9XG59XG5cbmNsYXNzIF9UcmFuc2Zvcm1JbnB1dFZhbHVlIHtcbiAgY29uc3RydWN0b3IocHVibGljIHZhbHVlOiBudW1iZXIsIHB1YmxpYyB1bml0OiBzdHJpbmcpIHt9XG59XG5cbmZ1bmN0aW9uIHNwbGl0VHJhbnNmb3JtVmFsdWUodmFsdWU6IHN0cmluZyk6IF9UcmFuc2Zvcm1JbnB1dFZhbHVlW10ge1xuICByZXR1cm4gdmFsdWUuc3BsaXQoL1xccyosXFxzKi8pLm1hcChyYXdWYWx1ZSA9PiB7XG4gICAgcmV0dXJuIG5ldyBfVHJhbnNmb3JtSW5wdXRWYWx1ZSh0b0ludChyYXdWYWx1ZSksIGZpbmREaW1lbnNpb25hbFN1ZmZpeChyYXdWYWx1ZSkpO1xuICB9KTtcbn1cblxuY2xhc3MgX1RyYW5zZm9ybUtleWZyYW1lVmFsdWUge1xuICBwdWJsaWMgbGVuZ3RoOiBudW1iZXI7XG4gIHB1YmxpYyB1bml0czogc3RyaW5nW107XG4gIHB1YmxpYyBzMTogbnVtYmVyID0gMDtcbiAgcHVibGljIHMyOiBudW1iZXIgPSAwO1xuICBwdWJsaWMgczM6IG51bWJlciA9IDA7XG4gIHB1YmxpYyBzNDogbnVtYmVyID0gMDtcbiAgcHVibGljIGQxOiBudW1iZXIgPSAwO1xuICBwdWJsaWMgZDI6IG51bWJlciA9IDA7XG4gIHB1YmxpYyBkMzogbnVtYmVyID0gMDtcbiAgcHVibGljIGQ0OiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBwcm9wZXJ0eTogc3RyaW5nLCBmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcpIHtcbiAgICB2YXIgZGVmYXVsdEVudHJ5ID0gVFJBTlNGT1JNX1BST1BFUlRJRVNbcHJvcGVydHldO1xuICAgIHZhciBkZWZhdWx0VmFsdWVzID0gZGVmYXVsdEVudHJ5WydkZWZhdWx0cyddO1xuICAgIHZhciBkZWZhdWx0VW5pdHMgPSBkZWZhdWx0RW50cnlbJ3VuaXRzJ107XG4gICAgdGhpcy5sZW5ndGggPSBkZWZhdWx0VmFsdWVzLmxlbmd0aDtcblxuICAgIHZhciBmcm9tVmFsdWVzID0gc3BsaXRUcmFuc2Zvcm1WYWx1ZShmcm9tKTtcbiAgICB2YXIgdG9WYWx1ZXMgPSBzcGxpdFRyYW5zZm9ybVZhbHVlKHRvKTtcblxuICAgIHZhciBmMSA9IGZyb21WYWx1ZXNbMF07XG4gICAgdmFyIHQxID0gdG9WYWx1ZXNbMF07XG4gICAgdGhpcy5zMSA9IGYxLnZhbHVlO1xuICAgIHRoaXMuZDEgPSB0MS52YWx1ZSAtIGYxLnZhbHVlO1xuICAgIHRoaXMudW5pdHMgPSBbZGVmYXVsdFVuaXRzWzBdXTtcblxuICAgIHZhciBsID0gZnJvbVZhbHVlcy5sZW5ndGg7XG4gICAgaWYgKHRoaXMubGVuZ3RoID4gMSkge1xuICAgICAgbGV0IHVuaXQgPSBkZWZhdWx0VW5pdHNbMV07XG4gICAgICBpZiAobCA+IDEpIHtcbiAgICAgICAgbGV0IGYyID0gZnJvbVZhbHVlc1sxXTtcbiAgICAgICAgbGV0IHQyID0gdG9WYWx1ZXNbMV07XG4gICAgICAgIHVuaXQgPSBmMi51bml0O1xuICAgICAgICB0aGlzLnMyID0gZjIudmFsdWU7XG4gICAgICAgIHRoaXMuZDIgPSB0Mi52YWx1ZSAtIGYyLnZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zMiA9IGRlZmF1bHRWYWx1ZXNbMV07XG4gICAgICB9XG4gICAgICB0aGlzLnVuaXRzLnB1c2godW5pdCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubGVuZ3RoID4gMikge1xuICAgICAgbGV0IHVuaXQgPSBkZWZhdWx0VW5pdHNbMl07XG4gICAgICBpZiAobCA+IDIpIHtcbiAgICAgICAgbGV0IGYzID0gZnJvbVZhbHVlc1syXTtcbiAgICAgICAgbGV0IHQzID0gdG9WYWx1ZXNbMl07XG4gICAgICAgIHVuaXQgPSBmMy51bml0O1xuICAgICAgICB0aGlzLnMzID0gZjMudmFsdWU7XG4gICAgICAgIHRoaXMuZDMgPSB0My52YWx1ZSAtIGYzLnZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zMyA9IGRlZmF1bHRWYWx1ZXNbMl07XG4gICAgICB9XG4gICAgICB0aGlzLnVuaXRzLnB1c2godW5pdCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubGVuZ3RoID4gMykge1xuICAgICAgbGV0IHVuaXQgPSBkZWZhdWx0VW5pdHNbM107XG4gICAgICBpZiAobCA+IDMpIHtcbiAgICAgICAgbGV0IGY0ID0gZnJvbVZhbHVlc1szXTtcbiAgICAgICAgbGV0IHQ0ID0gdG9WYWx1ZXNbM107XG4gICAgICAgIHVuaXQgPSBmNC51bml0O1xuICAgICAgICB0aGlzLnM0ID0gZjQudmFsdWU7XG4gICAgICAgIHRoaXMuZDQgPSB0NC52YWx1ZSAtIGY0LnZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zNCA9IGRlZmF1bHRWYWx1ZXNbM107XG4gICAgICB9XG4gICAgICB0aGlzLnVuaXRzLnB1c2godW5pdCk7XG4gICAgfVxuICB9XG5cbiAgY2FsY3VsYXRlQXRQZXJjZW50YWdlKHBlcmNlbnRhZ2U6IG51bWJlcik6IHN0cmluZ1tdIHtcbiAgICB2YXIgdW5pdHMgPSB0aGlzLnVuaXRzO1xuICAgIHZhciB2MSA9IHRoaXMuczEgKyBwZXJjZW50YWdlICogdGhpcy5kMSArIHVuaXRzWzBdO1xuICAgIHZhciB2MiA9IHRoaXMuczIgKyBwZXJjZW50YWdlICogdGhpcy5kMiArIHVuaXRzWzFdO1xuICAgIHZhciB2MyA9IHRoaXMuczMgKyBwZXJjZW50YWdlICogdGhpcy5kMyArIHVuaXRzWzJdO1xuICAgIHZhciB2NCA9IHRoaXMuczQgKyBwZXJjZW50YWdlICogdGhpcy5kNCArIHVuaXRzWzNdO1xuICAgIHZhciByZXN1bHQgPSBbdjEsdjIsdjMsdjRdO1xuICAgIHJlc3VsdC5sZW5ndGggPSB0aGlzLmxlbmd0aDtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG5cbi8vIHdlIHVzZSBsb29rIGFoZWFkIGhlcmUgc28gdGhhdCB0aGUgc3BsaXRcbi8vIG9wZXJhdGlvbiBkb2Vzbid0IGluY2x1ZGUgdGhlIGBcXHcrKGAgY29udGVudFxuLy8gYXMgYXBhcnQgb2YgdGhlIHNwbGl0IGRlbGltZXRlci5cbnZhciBUUkFOU0ZPUk1fU1BMSVRfUkVHRVggPSBuZXcgUmVnRXhwKFxuICAnXFxcXHMrJyArIC8vIGxvb2sgZm9yIHNwYWNlcy4uLlxuICAnKD89XFxcXHcrXFxcXCgpJyAvLyB0aGF0IGFyZSBmb2xsb3dlZCBieSBhIGtleXdvcmQgY29udGFpbmluZyBhIG9wZW5pbmcgcGFyZW4oXG4pO1xuXG5jbGFzcyBfVHJhbnNmb3JtRGV0YWlscyB7XG4gIHB1YmxpYyB2YWx1ZXM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd8bnVtYmVyfSA9IHt9O1xuICBwdWJsaWMgcHJvcGVydGllczogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgc3R5bGU6IHN0cmluZykge1xuICAgIHN0eWxlLnNwbGl0KFRSQU5TRk9STV9TUExJVF9SRUdFWCkuZm9yRWFjaCh0b2tlbiA9PiB7XG4gICAgICB2YXIgcGFyZW5PcGVuID0gdG9rZW4uaW5kZXhPZignKCcpO1xuICAgICAgdmFyIHBhcmVuQ2xvc2UgPSB0b2tlbi5sYXN0SW5kZXhPZignKScpO1xuICAgICAgdmFyIGxocyA9IHRva2VuLnN1YnN0cmluZygwLCBwYXJlbk9wZW4pO1xuICAgICAgdmFyIHJocyA9IHRva2VuLnN1YnN0cmluZyhwYXJlbk9wZW4gKyAxLCBwYXJlbkNsb3NlKTtcbiAgICAgIHRoaXMudmFsdWVzW2xoc10gPSByaHM7XG4gICAgICB0aGlzLnByb3BlcnRpZXMucHVzaChsaHMpO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZUZyb21UcmFuc2Zvcm1Qcm9wZXJ0aWVzKHByb3BlcnRpZXM6IHN0cmluZ1tdKTogX1N0eWxlVGVtcGxhdGUge1xuICB2YXIgdG9rZW5zID0gW107XG4gIHZhciB0b2tlbkxvb2t1cDoge1trZXk6IHN0cmluZ106IG51bWJlcn0gPSB7fTtcbiAgcHJvcGVydGllcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgIHZhciBlbnRyeSA9IFRSQU5TRk9STV9QUk9QRVJUSUVTW3Byb3BdWydkZWZhdWx0cyddO1xuICAgIHRva2Vucy5wdXNoKHByb3ApO1xuICAgIHRva2Vucy5wdXNoKFwiKFwiKTtcbiAgICB0b2tlbkxvb2t1cFtwcm9wXSA9IHRva2Vucy5sZW5ndGg7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyeS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGkgPiAwKSB7XG4gICAgICAgIHRva2Vucy5wdXNoKFwiLFwiKTtcbiAgICAgIH1cbiAgICAgIHRva2Vucy5wdXNoKHRydWUpO1xuICAgIH1cbiAgICB0b2tlbnMucHVzaChcIilcIik7XG4gICAgdG9rZW5zLnB1c2goXCIgXCIpO1xuICB9KTtcbiAgcmV0dXJuIG5ldyBfU3R5bGVUZW1wbGF0ZSh0b2tlbnMsIHRva2VuTG9va3VwKTtcbn1cblxuZnVuY3Rpb24gY29uY2F0VmFsdWVzQW5kVW5pdHModmFsdWVzLCB1bml0cyk6IHN0cmluZyB7XG4gIHZhciBjb21iaW5lZCA9IFtdO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbWJpbmVkLnB1c2godmFsdWVzW2ldICsgdW5pdHNbaV0pO1xuICB9XG4gIHJldHVybiBjb21iaW5lZC5qb2luKCcsJyk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlS2V5ZnJhbWVzQmV0d2VlblRyYW5zZm9ybXMoYTogX1RyYW5zZm9ybURldGFpbHMsIGI6IF9UcmFuc2Zvcm1EZXRhaWxzKTogX1RyYW5zZm9ybUtleWZyYW1lVmFsdWVbXSB7XG4gIHZhciB1c2VkUHJvcGVydGllcyA9IHt9O1xuXG4gIHZhciBmcm9tID0ge307XG4gIHZhciB0byA9IHt9O1xuXG4gIGEucHJvcGVydGllcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgIHVzZWRQcm9wZXJ0aWVzW3Byb3BdID0gMTtcbiAgICBmcm9tW3Byb3BdID0gYS52YWx1ZXNbcHJvcF07XG4gIH0pO1xuXG4gIGIucHJvcGVydGllcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgIHZhciB2YWwgPSB1c2VkUHJvcGVydGllc1twcm9wXTtcbiAgICB1c2VkUHJvcGVydGllc1twcm9wXSA9IHZhbCA9PSAxID8gMCA6IC0xO1xuICAgIHRvW3Byb3BdID0gYi52YWx1ZXNbcHJvcF07XG4gIH0pO1xuXG4gIHZhciBrZXlmcmFtZXMgPSBbXTtcbiAgZm9yRWFjaCh1c2VkUHJvcGVydGllcywgKHN0YXR1cywgcHJvcCkgPT4ge1xuICAgIGxldCBkZWZhdWx0VmFsdWUgPSBUUkFOU0ZPUk1fUFJPUEVSVElFU1twcm9wXTtcbiAgICBpZiAoc3RhdHVzID09IDEpIHtcbiAgICAgIHRvW3Byb3BdID0gY29uY2F0VmFsdWVzQW5kVW5pdHMoZGVmYXVsdFZhbHVlLmRlZmF1bHRzLCBkZWZhdWx0VmFsdWUudW5pdHMpO1xuICAgIH0gZWxzZSBpZiAoc3RhdHVzID09IC0xKSB7XG4gICAgICBmcm9tW3Byb3BdID0gY29uY2F0VmFsdWVzQW5kVW5pdHMoZGVmYXVsdFZhbHVlLmRlZmF1bHRzLCBkZWZhdWx0VmFsdWUudW5pdHMpO1xuICAgIH1cbiAgICBrZXlmcmFtZXMucHVzaChuZXcgX1RyYW5zZm9ybUtleWZyYW1lVmFsdWUocHJvcCwgZnJvbVtwcm9wXSwgdG9bcHJvcF0pKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGtleWZyYW1lcztcbn1cbiJdfQ==
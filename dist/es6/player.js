import { DIMENSIONAL_PROPERTIES } from './dimensional_properties';
import { NUMERICAL_PROPERTIES } from './numerical_properties';
import { COLOR_PROPERTIES } from './color_properties';
import { forEach, toInt, isPresent } from './util';
import { DimensionalStyleCalculator } from './calculators/dimensional_style_calculator';
import { NumericalStyleCalculator } from './calculators/numerical_style_calculator';
import { TransformStyleCalculator } from './calculators/transform_style_calculator';
import { ColorStyleCalculator } from './calculators/color_style_calculator';
import { resolveEasingEquation } from './easing';
export class AnimationPropertyEntry {
    constructor(property, calculator) {
        this.property = property;
        this.calculator = calculator;
    }
}
export class PlayerOptions {
    constructor({ duration, delay, easing, fill }) {
        this.duration = toInt(duration);
        this.delay = isPresent(delay) ? toInt(delay) : 0;
        this.easing = isPresent(easing) ? easing : 'linear';
        switch (fill) {
            case 'forwards':
            case 'backwards':
            case 'both':
                this.fill = fill;
                break;
            default:
                this.fill = 'none';
                break;
        }
    }
}
function createCalculator(prop, values) {
    var calc;
    if (DIMENSIONAL_PROPERTIES.indexOf(prop) >= 0) {
        calc = new DimensionalStyleCalculator();
    }
    else if (NUMERICAL_PROPERTIES.indexOf(prop) >= 0) {
        calc = new NumericalStyleCalculator();
    }
    else if (prop == 'transform') {
        calc = new TransformStyleCalculator();
    }
    else if (COLOR_PROPERTIES.indexOf(prop) >= 0) {
        calc = new ColorStyleCalculator();
    }
    else {
        throw new Error('Only dimensional properties can be animated now');
    }
    calc.setKeyframeRange(values[0], values[1]);
    return calc;
}
export class Player {
    constructor(_element, keyframes, _options, _clock, _styles) {
        this._element = _element;
        this._options = _options;
        this._clock = _clock;
        this._styles = _styles;
        this._currentTime = 0;
        this._startingTimestamp = 0;
        this.onfinish = () => { };
        var properties = {};
        var firstKeyframe = keyframes[0];
        forEach(firstKeyframe, (value, prop) => {
            properties[prop] = [value];
        });
        var secondKeyframe = keyframes[1];
        forEach(secondKeyframe, (value, prop) => {
            properties[prop].push(value);
        });
        this._animators = [];
        forEach(properties, (values, prop) => {
            var calculator = createCalculator(prop, values);
            this._animators.push(new AnimationPropertyEntry(prop, calculator));
        });
        this._easingEquation = resolveEasingEquation(_options.easing);
    }
    get totalTime() {
        return this._options.duration;
    }
    get currentTime() {
        return this._currentTime;
    }
    play() {
        if (this.playing)
            return;
        this._initialValues = {};
        this._animators.forEach(entry => {
            var prop = entry.property;
            this._initialValues[prop] = this._styles.readStyle(this._element, prop);
        });
        this.playing = true;
        this._startingTimestamp = this._clock.now();
        this.tick();
    }
    _onfinish() {
        var fill = this._options.fill;
        if (fill == 'none' || fill == 'backwards') {
            this._cleanup();
        }
        this.onfinish();
    }
    _oncancel() {
        this._cleanup();
    }
    _ease(percentage) {
        return this._easingEquation(percentage);
    }
    _computeProperties(currentTime) {
        var results = [];
        var totalTime = this.totalTime;
        var percentage = Math.min(currentTime / totalTime, 1);
        var percentageWithEasing = this._ease(percentage);
        this._animators.forEach(entry => {
            var calculator = entry.calculator;
            results.push([entry.property, calculator.calculate(percentageWithEasing)]);
        });
        return results;
    }
    tick() {
        var currentTime = this._clock.currentTime - this._startingTimestamp;
        this._computeProperties(currentTime).forEach(entry => this._apply(entry[0], entry[1]));
        if (this._currentTime >= this.totalTime) {
            this._onfinish();
        }
        else {
            this._clock.raf(() => this.tick());
        }
        this._currentTime = currentTime;
    }
    _cleanup() {
        this._animators.forEach(entry => {
            var property = entry.property;
            this._apply(property, this._initialValues[property]);
        });
        this._initialValues = null;
    }
    _apply(prop, value) {
        this._element.style[prop] = value;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGxheWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUVPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwwQkFBMEI7T0FDeEQsRUFBQyxvQkFBb0IsRUFBQyxNQUFNLHdCQUF3QjtPQUNwRCxFQUFDLGdCQUFnQixFQUFDLE1BQU0sb0JBQW9CO09BQzVDLEVBQUMsT0FBTyxFQUFnQixLQUFLLEVBQXFCLFNBQVMsRUFBQyxNQUFNLFFBQVE7T0FDMUUsRUFBQywwQkFBMEIsRUFBQyxNQUFNLDRDQUE0QztPQUM5RSxFQUFDLHdCQUF3QixFQUFDLE1BQU0sMENBQTBDO09BQzFFLEVBQUMsd0JBQXdCLEVBQUMsTUFBTSwwQ0FBMEM7T0FDMUUsRUFBQyxvQkFBb0IsRUFBQyxNQUFNLHNDQUFzQztPQUVsRSxFQUFDLHFCQUFxQixFQUFDLE1BQU0sVUFBVTtBQUU5QztJQUNFLFlBQW1CLFFBQWdCLEVBQVMsVUFBMkI7UUFBcEQsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUFTLGVBQVUsR0FBVixVQUFVLENBQWlCO0lBQUcsQ0FBQztBQUM3RSxDQUFDO0FBRUQ7SUFNRSxZQUFhLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUsxQztRQUNDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsTUFBTSxHQUFHLFFBQVEsQ0FBQztRQUVwRCxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2IsS0FBSyxVQUFVLENBQUM7WUFDaEIsS0FBSyxXQUFXLENBQUM7WUFDakIsS0FBSyxNQUFNO2dC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QUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQztJQUNsQyxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUs7WUFDM0IsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztZQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztJQUM3QixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQVksRUFBRSxLQUFhO1FBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUNwQyxDQUFDO0FBQ0gsQ0FBQztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtCcm93c2VyQ2xvY2t9IGZyb20gJy4vYnJvd3Nlcl9jbG9jay50cyc7XG5pbXBvcnQge0Jyb3dzZXJTdHlsZXN9IGZyb20gJy4vYnJvd3Nlcl9zdHlsZXMnO1xuaW1wb3J0IHtESU1FTlNJT05BTF9QUk9QRVJUSUVTfSBmcm9tICcuL2RpbWVuc2lvbmFsX3Byb3BlcnRpZXMnO1xuaW1wb3J0IHtOVU1FUklDQUxfUFJPUEVSVElFU30gZnJvbSAnLi9udW1lcmljYWxfcHJvcGVydGllcyc7XG5pbXBvcnQge0NPTE9SX1BST1BFUlRJRVN9IGZyb20gJy4vY29sb3JfcHJvcGVydGllcyc7XG5pbXBvcnQge2ZvckVhY2gsIHJvdW5kRGVjaW1hbCwgdG9JbnQsIHRvRmxvYXQsIGlzTnVtYmVyLCBpc1ByZXNlbnR9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQge0RpbWVuc2lvbmFsU3R5bGVDYWxjdWxhdG9yfSBmcm9tICcuL2NhbGN1bGF0b3JzL2RpbWVuc2lvbmFsX3N0eWxlX2NhbGN1bGF0b3InO1xuaW1wb3J0IHtOdW1lcmljYWxTdHlsZUNhbGN1bGF0b3J9IGZyb20gJy4vY2FsY3VsYXRvcnMvbnVtZXJpY2FsX3N0eWxlX2NhbGN1bGF0b3InO1xuaW1wb3J0IHtUcmFuc2Zvcm1TdHlsZUNhbGN1bGF0b3J9IGZyb20gJy4vY2FsY3VsYXRvcnMvdHJhbnNmb3JtX3N0eWxlX2NhbGN1bGF0b3InO1xuaW1wb3J0IHtDb2xvclN0eWxlQ2FsY3VsYXRvcn0gZnJvbSAnLi9jYWxjdWxhdG9ycy9jb2xvcl9zdHlsZV9jYWxjdWxhdG9yJztcbmltcG9ydCB7U3R5bGVDYWxjdWxhdG9yfSBmcm9tICcuL3N0eWxlX2NhbGN1bGF0b3InO1xuaW1wb3J0IHtyZXNvbHZlRWFzaW5nRXF1YXRpb259IGZyb20gJy4vZWFzaW5nJztcblxuZXhwb3J0IGNsYXNzIEFuaW1hdGlvblByb3BlcnR5RW50cnkge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgcHJvcGVydHk6IHN0cmluZywgcHVibGljIGNhbGN1bGF0b3I6IFN0eWxlQ2FsY3VsYXRvcikge31cbn1cblxuZXhwb3J0IGNsYXNzIFBsYXllck9wdGlvbnMge1xuICBwdWJsaWMgZHVyYXRpb246IG51bWJlcjtcbiAgcHVibGljIGRlbGF5OiBudW1iZXI7XG4gIHB1YmxpYyBlYXNpbmc6IHN0cmluZztcbiAgcHVibGljIGZpbGw6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvciAoe2R1cmF0aW9uLCBkZWxheSwgZWFzaW5nLCBmaWxsfToge1xuICAgIGR1cmF0aW9uOiBudW1iZXJ8c3RyaW5nLFxuICAgIGRlbGF5PzogbnVtYmVyfHN0cmluZyxcbiAgICBlYXNpbmc/OiBzdHJpbmcsXG4gICAgZmlsbD86IHN0cmluZ1xuICB9KSB7XG4gICAgdGhpcy5kdXJhdGlvbiA9IHRvSW50KGR1cmF0aW9uKTtcbiAgICB0aGlzLmRlbGF5ID0gaXNQcmVzZW50KGRlbGF5KSA/IHRvSW50KGRlbGF5KSA6IDA7XG4gICAgdGhpcy5lYXNpbmcgPSBpc1ByZXNlbnQoZWFzaW5nKSA/IGVhc2luZyA6ICdsaW5lYXInO1xuXG4gICAgc3dpdGNoIChmaWxsKSB7XG4gICAgICBjYXNlICdmb3J3YXJkcyc6XG4gICAgICBjYXNlICdiYWNrd2FyZHMnOlxuICAgICAgY2FzZSAnYm90aCc6XG4gICAgICAgIHRoaXMuZmlsbCA9IGZpbGw7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5maWxsID0gJ25vbmUnO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlQ2FsY3VsYXRvcihwcm9wOiBzdHJpbmcsIHZhbHVlczogYW55W10pOiBTdHlsZUNhbGN1bGF0b3Ige1xuICB2YXIgY2FsYzogU3R5bGVDYWxjdWxhdG9yO1xuICBpZiAoRElNRU5TSU9OQUxfUFJPUEVSVElFUy5pbmRleE9mKHByb3ApID49IDApIHtcbiAgICBjYWxjID0gbmV3IERpbWVuc2lvbmFsU3R5bGVDYWxjdWxhdG9yKCk7XG4gIH0gZWxzZSBpZiAoTlVNRVJJQ0FMX1BST1BFUlRJRVMuaW5kZXhPZihwcm9wKSA+PSAwKSB7XG4gICAgY2FsYyA9IG5ldyBOdW1lcmljYWxTdHlsZUNhbGN1bGF0b3IoKTtcbiAgfSBlbHNlIGlmIChwcm9wID09ICd0cmFuc2Zvcm0nKSB7XG4gICAgY2FsYyA9IG5ldyBUcmFuc2Zvcm1TdHlsZUNhbGN1bGF0b3IoKTtcbiAgfSBlbHNlIGlmIChDT0xPUl9QUk9QRVJUSUVTLmluZGV4T2YocHJvcCkgPj0gMCkge1xuICAgIGNhbGMgPSBuZXcgQ29sb3JTdHlsZUNhbGN1bGF0b3IoKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgZGltZW5zaW9uYWwgcHJvcGVydGllcyBjYW4gYmUgYW5pbWF0ZWQgbm93Jyk7XG4gIH1cbiAgY2FsYy5zZXRLZXlmcmFtZVJhbmdlKDxzdHJpbmd8bnVtYmVyPnZhbHVlc1swXSwgPHN0cmluZ3xudW1iZXI+dmFsdWVzWzFdKTtcbiAgcmV0dXJuIGNhbGM7XG59XG5cbmV4cG9ydCBjbGFzcyBQbGF5ZXIge1xuICBwcml2YXRlIF9jdXJyZW50VGltZTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBfc3RhcnRpbmdUaW1lc3RhbXA6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgX2FuaW1hdG9yczogQW5pbWF0aW9uUHJvcGVydHlFbnRyeVtdO1xuICBwcml2YXRlIF9pbml0aWFsVmFsdWVzOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfTtcbiAgcHJpdmF0ZSBfZWFzaW5nRXF1YXRpb246IEZ1bmN0aW9uO1xuXG4gIG9uZmluaXNoOiBGdW5jdGlvbiA9ICgpID0+IHt9O1xuICBwbGF5aW5nOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2VsZW1lbnQ6IEhUTUxFbGVtZW50LFxuICAgICAgICAgICAgICBrZXlmcmFtZXM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10sXG4gICAgICAgICAgICAgIHByaXZhdGUgX29wdGlvbnM6IFBsYXllck9wdGlvbnMsXG4gICAgICAgICAgICAgIHByaXZhdGUgX2Nsb2NrOiBCcm93c2VyQ2xvY2ssXG4gICAgICAgICAgICAgIHByaXZhdGUgX3N0eWxlczogQnJvd3NlclN0eWxlcykge1xuXG4gICAgdmFyIHByb3BlcnRpZXMgPSB7fTtcbiAgICB2YXIgZmlyc3RLZXlmcmFtZSA9IGtleWZyYW1lc1swXTtcbiAgICBmb3JFYWNoKGZpcnN0S2V5ZnJhbWUsICh2YWx1ZSwgcHJvcCkgPT4ge1xuICAgICAgcHJvcGVydGllc1twcm9wXSA9IFt2YWx1ZV07XG4gICAgfSk7XG5cbiAgICB2YXIgc2Vjb25kS2V5ZnJhbWUgPSBrZXlmcmFtZXNbMV07XG4gICAgZm9yRWFjaChzZWNvbmRLZXlmcmFtZSwgKHZhbHVlLCBwcm9wKSA9PiB7XG4gICAgICBwcm9wZXJ0aWVzW3Byb3BdLnB1c2godmFsdWUpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fYW5pbWF0b3JzID0gW107XG4gICAgZm9yRWFjaChwcm9wZXJ0aWVzLCAodmFsdWVzLCBwcm9wKSA9PiB7XG4gICAgICB2YXIgY2FsY3VsYXRvciA9IGNyZWF0ZUNhbGN1bGF0b3IocHJvcCwgdmFsdWVzKTtcbiAgICAgIHRoaXMuX2FuaW1hdG9ycy5wdXNoKG5ldyBBbmltYXRpb25Qcm9wZXJ0eUVudHJ5KHByb3AsIGNhbGN1bGF0b3IpKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX2Vhc2luZ0VxdWF0aW9uID0gcmVzb2x2ZUVhc2luZ0VxdWF0aW9uKF9vcHRpb25zLmVhc2luZyk7XG4gIH1cblxuICBnZXQgdG90YWxUaW1lKCkge1xuICAgIHJldHVybiB0aGlzLl9vcHRpb25zLmR1cmF0aW9uO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRUaW1lKCkge1xuICAgIHJldHVybiB0aGlzLl9jdXJyZW50VGltZTtcbiAgfVxuXG4gIHBsYXkoKSB7XG4gICAgaWYgKHRoaXMucGxheWluZykgcmV0dXJuO1xuICAgIHRoaXMuX2luaXRpYWxWYWx1ZXMgPSB7fTtcbiAgICB0aGlzLl9hbmltYXRvcnMuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICB2YXIgcHJvcCA9IGVudHJ5LnByb3BlcnR5O1xuICAgICAgdGhpcy5faW5pdGlhbFZhbHVlc1twcm9wXSA9IHRoaXMuX3N0eWxlcy5yZWFkU3R5bGUodGhpcy5fZWxlbWVudCwgcHJvcCk7XG4gICAgfSk7XG4gICAgdGhpcy5wbGF5aW5nID0gdHJ1ZTtcbiAgICB0aGlzLl9zdGFydGluZ1RpbWVzdGFtcCA9IHRoaXMuX2Nsb2NrLm5vdygpO1xuICAgIHRoaXMudGljaygpO1xuICB9XG5cbiAgX29uZmluaXNoKCkge1xuICAgIHZhciBmaWxsID0gdGhpcy5fb3B0aW9ucy5maWxsO1xuICAgIGlmIChmaWxsID09ICdub25lJyB8fCBmaWxsID09ICdiYWNrd2FyZHMnKSB7XG4gICAgICB0aGlzLl9jbGVhbnVwKCk7XG4gICAgfVxuICAgIHRoaXMub25maW5pc2goKTtcbiAgfVxuXG4gIF9vbmNhbmNlbCgpIHtcbiAgICB0aGlzLl9jbGVhbnVwKCk7XG4gIH1cblxuICBfZWFzZShwZXJjZW50YWdlKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Vhc2luZ0VxdWF0aW9uKHBlcmNlbnRhZ2UpO1xuICB9XG5cbiAgX2NvbXB1dGVQcm9wZXJ0aWVzKGN1cnJlbnRUaW1lOiBudW1iZXIpOiBzdHJpbmdbXSB7XG4gICAgdmFyIHJlc3VsdHMgPSBbXTtcbiAgICB2YXIgdG90YWxUaW1lID0gdGhpcy50b3RhbFRpbWU7XG4gICAgdmFyIHBlcmNlbnRhZ2UgPSBNYXRoLm1pbihjdXJyZW50VGltZSAvIHRvdGFsVGltZSwgMSk7XG4gICAgdmFyIHBlcmNlbnRhZ2VXaXRoRWFzaW5nID0gdGhpcy5fZWFzZShwZXJjZW50YWdlKTtcblxuICAgIHRoaXMuX2FuaW1hdG9ycy5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIHZhciBjYWxjdWxhdG9yID0gZW50cnkuY2FsY3VsYXRvcjtcbiAgICAgIHJlc3VsdHMucHVzaChbZW50cnkucHJvcGVydHksIGNhbGN1bGF0b3IuY2FsY3VsYXRlKHBlcmNlbnRhZ2VXaXRoRWFzaW5nKV0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICB0aWNrKCkge1xuICAgIHZhciBjdXJyZW50VGltZSA9IHRoaXMuX2Nsb2NrLmN1cnJlbnRUaW1lIC0gdGhpcy5fc3RhcnRpbmdUaW1lc3RhbXA7XG4gICAgdGhpcy5fY29tcHV0ZVByb3BlcnRpZXMoY3VycmVudFRpbWUpLmZvckVhY2goZW50cnkgPT4gdGhpcy5fYXBwbHkoZW50cnlbMF0sIGVudHJ5WzFdKSk7XG5cbiAgICBpZiAodGhpcy5fY3VycmVudFRpbWUgPj0gdGhpcy50b3RhbFRpbWUpIHtcbiAgICAgIHRoaXMuX29uZmluaXNoKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2Nsb2NrLnJhZigoKSA9PiB0aGlzLnRpY2soKSk7XG4gICAgfVxuXG4gICAgdGhpcy5fY3VycmVudFRpbWUgPSBjdXJyZW50VGltZTtcbiAgfVxuXG4gIF9jbGVhbnVwKCkge1xuICAgIHRoaXMuX2FuaW1hdG9ycy5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIHZhciBwcm9wZXJ0eSA9IGVudHJ5LnByb3BlcnR5O1xuICAgICAgdGhpcy5fYXBwbHkocHJvcGVydHksIHRoaXMuX2luaXRpYWxWYWx1ZXNbcHJvcGVydHldKTtcbiAgICB9KTtcbiAgICB0aGlzLl9pbml0aWFsVmFsdWVzID0gbnVsbDtcbiAgfVxuXG4gIF9hcHBseShwcm9wOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9lbGVtZW50LnN0eWxlW3Byb3BdID0gdmFsdWU7XG4gIH1cbn1cbiJdfQ==